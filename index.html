<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rainfall Forecast Dashboard (HRRR Forecasting System)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 40px; background: #f4f4f9; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        h2 { margin-top: 0; color: #1a1a1a; margin-bottom: 5px; }
        .subtitle { color: #e2242c; font-weight: bold; font-size: 1.1em; margin-bottom: 25px; display: block; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; }
        
        .chart-section { margin-bottom: 50px; }
        h3 { font-size: 1.2em; color: #444; margin-bottom: 15px; border-left: 4px solid #e2242c; padding-left: 10px; }
        
        #dataStatus { font-size: 0.85em; color: #666; float: right; margin-top: -45px; }
        
        select { padding: 12px; width: 100%; margin-bottom: 20px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; background-color: #fff; cursor: pointer; }
        
        #statusBanner { 
            display: none; 
            padding: 12px; 
            margin-bottom: 25px; 
            border-radius: 6px; 
            text-align: center; 
            font-weight: bold; 
            font-size: 0.95em;
        }
        .processing { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        
        .last-run { font-size: 0.85em; color: #777; margin-top: 20px; text-align: right; font-style: italic; }
        canvas { max-height: 450px; width: 100% !important; }
    </style>
</head>
<body>

    <div class="container">
        <h2>Rainfall Forecast Dashboard (HRRR)</h2>
        <span class="subtitle">Center for Natural Resources</span>
        <div id="dataStatus"></div>
        
        <div id="statusBanner"></div>

        <div class="chart-section">
            <h3>Statewide Overview: Hourly Rain Peaks (All Regions)</h3>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                Expected hourly rainfall intensity. Higher peaks indicate periods of heavy rain.
            </p>
            <canvas id="statewideLineChart"></canvas>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 40px 0;">

        <div class="chart-section">
            <h3>Local Forecast Detail</h3>
            <p style="font-size: 0.9em; color: #666;">Select a region to view the expected rainfall spread.</p>
            <select id="citySelect" onchange="updateCityChart()">
                <option value="">Loading Regions...</option>
            </select>
            <canvas id="rainfallChart"></canvas>
        </div>

        <div id="lastRunTimestamp" class="last-run"></div>
    </div>

    <script>
        let forecastData = {};
        let cityChart;
        let statewideChart;

        async function loadDashboard() {
            try {
                const response = await fetch('data.json');
                const json = await response.json();
                
                const banner = document.getElementById('statusBanner');
                if (json.status === "processing") {
                    banner.innerHTML = "⚠️ Background Update: A new forecast is being processed.";
                    banner.className = "processing";
                    banner.style.display = "block";
                } else {
                    banner.style.display = "none";
                }

                forecastData = json.data; 
                const cities = Object.keys(forecastData).sort();
                
                // Show how many hours are currently loaded (e.g., 14/18)
                const hoursLoaded = forecastData[cities[0]].times.length;
                document.getElementById('dataStatus').innerText = `Forecast Depth: ${hoursLoaded} Hours`;

                if(json.last_run) {
                    document.getElementById('lastRunTimestamp').innerText = "Last web update: " + new Date(json.last_run).toLocaleString();
                }

                const select = document.getElementById('citySelect');
                select.innerHTML = '';
                cities.forEach(city => {
                    let opt = document.createElement('option');
                    opt.value = city;
                    opt.innerHTML = city;
                    select.appendChild(opt);
                });

                initLineChart(cities);
                initCityChart(cities[0]);

            } catch (err) {
                console.error("Error loading forecast data:", err);
            }
        }

        function formatTime(t) {
            return new Date(t).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Helper to generate distinct colors for each region
        function getColor(index, total) {
            const hue = (index * (360 / total)) % 360;
            return `hsl(${hue}, 70%, 50%)`;
        }

        function initLineChart(cities) {
            const ctx = document.getElementById('statewideLineChart').getContext('2d');
            const datasets = [];

            cities.forEach((city, index) => {
                const cityData = forecastData[city];
                const color = getColor(index, cities.length); // Unique color per city

                datasets.push({
                    label: city,
                    data: cityData.p100, 
                    borderColor: color,      // Now distinct!
                    backgroundColor: color,  // For the legend/tooltip
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                    fill: false,
                    tension: 0.4,
                    showLine: true
                });
            });

            const labels = forecastData[cities[0]].times.map(t => formatTime(t));

            if (statewideChart) statewideChart.destroy();

            statewideChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { 
                            display: true, // Re-enabled so you can see which color is which
                            position: 'bottom',
                            labels: { boxWidth: 12, font: { size: 10 } }
                        },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Time' } },
                        y: { beginAtZero: true, title: { display: true, text: 'Inches' } }
                    }
                }
            });
        }

        function initCityChart(city) {
            const ctx = document.getElementById('rainfallChart').getContext('2d');
            const data = forecastData[city];

            if (cityChart) cityChart.destroy();
            cityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.times.map(t => formatTime(t)),
                    datasets: [
                        { label: 'Expected (Median)', data: data.p50, backgroundColor: 'rgba(54, 162, 235, 0.7)' },
                        { label: 'Likely High (75th)', data: data.p75, backgroundColor: 'rgba(255, 159, 64, 0.7)' },
                        { label: 'Potential Peak (Max)', data: data.p100, backgroundColor: 'rgba(226, 36, 44, 0.7)' }
                    ]
                },
                options: { 
                    responsive: true,
                    plugins: { title: { display: true, text: 'Expected Rainfall Spread' } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Inches per Hour' } } }
                }
            });
        }

        function updateCityChart() {
            const city = document.getElementById('citySelect').value;
            const data = forecastData[city];
            if (!data) return;

            cityChart.data.labels = data.times.map(t => formatTime(t));
            cityChart.data.datasets[0].data = data.p50;
            cityChart.data.datasets[1].data = data.p75;
            cityChart.data.datasets[2].data = data.p100;
            cityChart.update();
        }

        loadDashboard();
        setTimeout(() => { location.reload(); }, 300000); // Check for background updates every 5 mins
    </script>
</body>
</html>